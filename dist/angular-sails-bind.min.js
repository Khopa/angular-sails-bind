/*! angular-sails-bind - v1.0.5 - 2014-10-04
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2014 Diego Pamio; Licensed MIT */
function diff(n,r){return n.filter(function(n){return r.indexOf(n)<0})}var app=angular.module("ngSailsBind",[]);app.factory("$sailsBind",["$q","$rootScope","$timeout","$log",function(n,r,t,e){"use strict";var i=function(i,a,u,c){function f(n){var r=a[i+"s"],o={created:function(){return a[i+"s"].push(n.data),void 0!=c&&c("created",n),!0},updated:function(){var t=r.find(function(r){return n.id==r.id});return t?(angular.extend(t,n.data),void 0!=c&&c("updated",n),!0):!1},destroyed:function(){var t=r.find(function(r){return n.id==r.id});return t?(r.splice(r.indexOf(t),1),n.data=t,void 0!=c&&c("destroyed",n),!0):!1},removedFrom:function(){var t=r.find(function(r){return n.id==r.id});if(t){var e=t[n.attribute];if(void 0!=e){var i=e.find(function(r){return n.removedId==r.id});if(i)return e.splice(e.indexOf(i),1),void 0!=c&&c("removedFrom",n),!0}}return!1},addedTo:function(){var t=r.find(function(r){return n.id==r.id});if(t){var e=a[n.attribute];if(e){var i=e.find(function(r){return n.addedId==r.id});if(i)return t[n.attribute].push(i),void 0!=c&&c("addedTo",n),!0}}return!1}};o[n.verb]?o[n.verb]()&&t(function(){a.$apply()}):e.log("Unknown action »"+n.verb+"«")}function s(){a.$watchCollection(i+"s",function(n,t){var e,u;n=n||[],t=t||[],e=diff(n,t),u=diff(t,n),u.forEach(function(n){d("/"+l+i+"?id="+n.id).then(function(t){t&&!t.error&&(r.$broadcast(i,{id:n.id,verb:"destroyed",scope:a.$id}),io.socket["delete"]("/"+l+i+"/destroy/"+n.id))})}),e.forEach(function(n){n.id||io.socket.put("/"+l+i+"/create/",n,function(t){d("/"+l+i+"/"+t.id).then(function(t){angular.extend(n,t),r.$broadcast(i,{id:n.id,verb:"created",scope:a.$id,data:angular.copy(n)})})})}),o(e,a,i,l)})}var l=i.split("/");l.length>1?(i=l.splice(l.length-1,1),l=l.join("/")+"/"):l="";var p=new n.defer;a[i+"s"]=[];var v=d("/"+l+i,u);return v.then(function(n){Array.isArray(n)||(n=[n]),a[i+"s"]=n,o(n,a,i,l),void 0!=c&&c("initialized",n),s(),p.resolve()}),io.socket.on(i,f),a.$on(i,function(n,r){a.$id!=r.scope&&f(r)}),p.promise},o=function(n,t,e,i){n.forEach(function(n){t.$watchCollection(e+"s["+t[e+"s"].indexOf(n)+"]",function(n,o){o&&n&&(angular.equals(o,n)||o.id!=n.id||o.updatedAt!==n.updatedAt||(r.$broadcast(e,{id:o.id,verb:"updated",scope:t.$id,data:angular.extend(angular.copy(n),{updatedAt:(new Date).toISOString()})}),io.socket.post("/"+i+e+"/update/"+o.id,angular.copy(n))))})})},d=function(t,e){var i=new n.defer;return e=e||{},io.socket.get(t,e,function(n){r.$apply(i.resolve(n))}),i.promise};return{bind:i}}]),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(n){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof n)throw new TypeError("predicate must be a function");for(var r,t=Object(this),e=t.length>>>0,i=arguments[1],o=0;e>o;o++)if(o in t&&(r=t[o],n.call(i,r,o,t)))return r;return void 0}}),Array.isArray||(Array.isArray=function(n){return"[object Array]"===Object.prototype.toString.call(n)});