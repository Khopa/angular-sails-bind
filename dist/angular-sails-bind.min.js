/*! angular-sails-bind - v0.2.0 - 2014-06-13
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2014 Diego Pamio; Licensed MIT */
var app=angular.module("ngSailsBind",[]);app.factory("$sailsBind",["$socket","$q",function(a,b){"use strict";var c=function(c,d,e){var f=new b.defer,g=a.get("/"+c,e);return g.then(function(a){d[c+"s"]=a,f.resolve()}),a.on(c,function(a){var b=d[c+"s"],e={created:function(){d[c+"s"].push(a.data)},updated:function(){var b=d[c+"s"].find(function(b){return parseInt(a.id,10)===parseInt(b.id,10)});angular.extend(b,a.data)},destroyed:function(){var e=d[c+"s"].find(function(b){return parseInt(b.id,10)===parseInt(a.id,10)});e&&b.splice(b.indexOf(e),1)}};e[a.verb]()}),d.$watchCollection(c+"s",function(b,e){function f(b){b.forEach(function(b){d.$watchCollection(c+"s["+d[c+"s"].indexOf(b)+"]",function(b,d){d&&b&&(angular.equals(d,b)||parseInt(d.id,10)!==parseInt(b.id,10)||d.updatedAt!==b.updatedAt||a.post("/"+c+"/update/"+d.id,angular.copy(b)))})})}!e&&b&&f(b);var g,h;b=b||[],e=e||[],g=b.diff(e),h=e.diff(b),h.forEach(function(b){a.get("/"+c+"?id="+b.id).then(function(d){d&&!d.error&&a.remove("/"+c+"/destroy/"+b.id)},function(){a.remove("/"+c+"/destroy/"+b.id)})}),g.forEach(function(b){b.id||a.put("/"+c+"/create/",b,function(d){a.get("/"+c+"/"+d.id).then(function(a){angular.extend(b,a)})}),f(g)})}),f.promise};return{bind:c}}]),app.factory("$socket",["$q","$rootScope",function(a,b){"use strict";var c={},d=function(d,e){var f=new a.defer;return e=e||{},e.cache=e.cache||!1,c[d]&&e.cache?b.$apply(f.resolve(c[d])):(delete e.cache,io.socket.request(d,e,function(a){c[d]=a,b.$apply(f.resolve(a))})),f.promise},e=function(a,c){io.socket.on(a,function(){var a=arguments;b.$apply(function(){c.apply(io.socket,a)})})},f=function(a,b,c){io.socket.post(a,b,c)},g=function(a,b,c){io.socket.put(a,b,c)},h=function(a,b){io.socket.delete(a,b)};return{get:d,on:e,post:f,put:g,remove:h}}]),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(f in c&&(b=c[f],a.call(e,b,f,c)))return b;return void 0}}),Array.prototype.diff||(Array.prototype.diff=function(a){return this.filter(function(b){return a.indexOf(b)<0})});